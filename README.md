### qemu-arch-att

https://wiki.archlinux.org/title/Installation_guide


```bash
image_dir=../images/qemu-arch-att
image=${image_dir}/archlinux-2025.06.01-x86_64.iso
disk=${image_dir}/arch.img
```


Create a disk drive, that is a file image:
```bash
$ qemu-img create ${disk} 10G
```
This time I want to log in using an ssh shell, because it is easier to copy/paste and the text is more easily increased. So, let's proceed to the install
```bash
$ qemu-system-x86_64  -m 2G -cdrom ${image} -hda ${disk} -net nic -net user,hostfwd=tcp::2222-:22
```
For ssh to work in a convenient way, the user setup is root, but with no password. Requiring a slight change in configuration in /etc/ssh/sshd_config

>PermitRootLogin yes
PermitEmptyPasswords yes

Restart sshd daemon and login by root using ssh will be possible

```bash
root@archiso ~ # systemctl restart sshd
```
```bash
$ ssh root@localhost -p 2222
```
The Archlinux suggest a set of keyboard and language settings, which I prefer to skip, because it doesn't really impact the installation process.

The network should be set up automatically.

If you are behind a proxy use

```bash
export http_proxy=some.proxy.fqdn.com:port-number
```
but also, might be necessary, difficult to tell.
```bash
export https_proxy=some.proxy.fqdn.com:port-number
```




##### Partitioning 

The disk drive should show up as /dev/sda. See the section below for [Disk partitioning](#my-header).


Mount the partition:

```bash
mount /dev/sda1 /mnt
```
If you are behind a proxy, allow pacman to update the cache


Get to the installation
```
# pacstrap -K /mnt base linux linux-firmware
```
Ran into problems and one suggestion on the screen was to run
```bash
# pacman-key --init
```
After about 4 failing key checks, the troubleshooting section suggests

```bash
pacman-key --populate archlinux
```
which allowed the installation to continue


```bash
$ qemu-system-x86_64  -m 2G -hda ${disk} -net nic -net user,hostfwd=tcp::2222-:22
```


Set up the /etc/fstab and chroot into the environment, while setting up basic time configuration
```
root@archiso ~ # genfstab -U /mnt >> /mnt/etc/fstab
root@archiso ~ # arch-chroot /mnt
[root@archiso /]# ln -sf /usr/share/zoneinfo/Europe/Berlin /etc/localtime
[root@archiso /]# hwclock --systohc
```

Add hostname

```
[root@archiso /]# echo italix > /etc/hostname
```

Even though initramfs was generated by pacstrap, they suggest creating a new one with 


```
[root@archiso /]# mkinitcpio -P
```

Change the root password, add a new user making sure to create the home directory with the "-m" flag



```
[root@archiso /]# passwd
New password:
Retype new password:
passwd: password updated successfully

[root@archiso /]# useradd -m italix

[root@archiso /]# passwd italix
New password:
Retype new password:
passwd: password updated successfully
[root@archiso /]#
```

INstall grub

```
[root@archiso /]# pacman -S grub
```

grub bootloader
```
[root@archiso /]# grub-install /dev/sda
Installing for i386-pc platform.
Installation finished. No error reported.
[root@archiso /]#
```


grub-install --target=i386-pc /dev/sda



Generate the grub configuration file


```[root@archiso /]# grub-mkconfig -o /boot/grub/grub.cfg
Generating grub configuration file ...
Found linux image: /boot/vmlinuz-linux
Found initrd image: /boot/initramfs-linux.img
Found fallback initrd image(s) in /boot:  initramfs-linux-fallback.img
Warning: os-prober will not be executed to detect other bootable partitions.
Systems on them will not be added to the GRUB boot configuration.
Check GRUB_DISABLE_OS_PROBER documentation entry.
Adding boot menu entry for UEFI Firmware Settings ...
done
[root@archiso /]#

```

setup dhcp, ssh, sudo, and vim

```
[root@archiso /]# pacman -S dhcpcd openssh
[root@archiso /]# pacman -S sudo
[root@archiso /]# pacman -S vim
```

Configure sudoers to allow passwordless sudo access for italix

>%wheel ALL=(ALL:ALL) NOPASSWD: ALL

Add new user italix to wheel group
```
[root@archiso /]# grep italix /etc/group
wheel:x:998:italix
italix:x:1000:
```












---
#### Additional information
Or proceed to the install, but try to add the user network
```bash
qemu-system-x86_64 -m 2G -cdrom ${image} -hda ${disk} -m 2G -net nic -net user,hostfwd=tcp::2222-:22
```


Then you can log into the system from the host:
```bash
# host > ssh -p 2222 italix@localhost
```


You could also use sftp when needed:
```bash
sftp localhost -oPort=2222
```


### <a id="my-header"></a> Disk partitioning

```bash
root@archiso ~ # lsblk
NAME  MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
fd0     2:0    1     4K  0 disk
loop0   7:0    0 853.9M  1 loop /run/archiso/airootfs
sda     8:0    0    10G  0 disk
sr0    11:0    1   1.2G  0 rom  /run/archiso/bootmnt
root@archiso ~ # fdisk /dev/sda
```
Start by "o -   create a new empty MBR (DOS) partition table"


```bash
Command (m for help): o
Created a new DOS (MBR) disklabel with disk identifier 0xd065093e.

Command (m for help): n
Partition type
   p   primary (0 primary, 0 extended, 4 free)
   e   extended (container for logical partitions)
Select (default p): p
Partition number (1-4, default 1):
First sector (2048-20971519, default 2048):
Last sector, +/-sectors or +/-size{K,M,G,T,P} (2048-20971519, default 20971519): +8G

Created a new partition 1 of type 'Linux' and of size 8 GiB.

Command (m for help): n
Partition type
   p   primary (1 primary, 0 extended, 3 free)
   e   extended (container for logical partitions)
Select (default p):

Using default response p.
Partition number (2-4, default 2):
First sector (16779264-20971519, default 16779264):
Last sector, +/-sectors or +/-size{K,M,G,T,P} (16779264-20971519, default 20971519):

Created a new partition 2 of type 'Linux' and of size 2 GiB.

Command (m for help): t
Partition number (1,2, default 2): 2
Hex code or alias (type L to list all): L
```
!! Note : Output truncated !!
```bash
Aliases:
   linux          - 83
   swap           - 82
Hex code or alias (type L to list all): 82

Changed type of partition 'Linux' to 'Linux swap / Solaris'.

Command (m for help): p
Disk arch.img: 10 GiB, 10737418240 bytes, 20971520 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0xd065093e

Device     Boot    Start      End  Sectors Size Id Type
arch.img1           2048 16779263 16777216   8G 83 Linux
arch.img2       16779264 20971519  4192256   2G 82 Linux swap / Solaris

Command (m for help): w
The partition table has been altered.

mi6577@CZBRN0475 UCRT64 ~
$ fdisk -l arch.img
Disk arch.img: 10 GiB, 10737418240 bytes, 20971520 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0xd065093e

Device     Boot    Start      End  Sectors Size Id Type
arch.img1           2048 16779263 16777216   8G 83 Linux
arch.img2       16779264 20971519  4192256   2G 82 Linux swap / Solaris
```

The final steps to create the file system and swap on those "disk" drives
```
# mkfs.ext4 /dev/sda1
```

If you created a partition for swap, initialize it with mkswap(8):
```
# mkswap /dev/sda2
# swapon /dev/sda2
```
